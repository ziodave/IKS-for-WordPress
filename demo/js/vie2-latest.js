(function(){var a=this.VIE2={};(function(b,c){b.widget("VIE2.vie2",{options:{entities:[]},_create:function(){jQuery.each(jQuery("html").xmlns(),function(g,f){a.namespaces[g]=f.toString();a.globalCache.prefix(g,f)});try{jQuery.each(this.element.xmlns(),function(g,f){a.namespaces[g]=f.toString();a.globalCache.prefix(g,f)})}catch(d){if(this.element.get(0)!==document){a.log("warn","VIE2.core#create()","Could not retrieve namespaces from element: '"+e+"'!")}}},analyze:function(h,d){if(!d){d={}}var g=this;if(h===c){a.log("warn","VIE2.core#analyze()","No callback method specified!")}a.log("info","VIE2.core#analyze()","Started.");var f=[];jQuery.each(a.connectors,function(){if(d.connectors){if(d.connectors.indexOf(this.id)!==-1){f.push(this.id)}}else{f.push(this.id)}});jQuery.each(a.connectors,function(){var i=function(k){return function(l){a.log("info","VIE2.core#analyze()","Received RDF annotation from connector '"+this.id+"'!");jQuery.each(a.namespaces,function(n,m){l.prefix(n,m)});l.databank.triples().each(function(){a.globalCache.add(this)});jQuery.each(l.databank.subjectIndex,function(o,n){var m=o.toString();if(g.options.entities.indexOf(m)===-1){g.options.entities.push(m)}if(!VIE.EntityManager.getBySubject(m)){a.log("info","VIE2.core#analyze()","Register new entity ("+m+")!");a.createEntity({id:m},{backend:true})}else{VIE.EntityManager.getBySubject(m).change()}});a.Util.removeElement(f,this.id);if(f.length===0){a.log("info","VIE2.core#analyze()","Finished! Global Cache holds now "+a.globalCache.databank.triples().length+" triples!");a.log("info","VIE2.core#analyze()","Finished! Local element holds now "+g.options.entities.length+" entities!");if(h){h.call(k)}}}}(g.element);var j=function(k){a.log("error","VIE2.core#analyze()","Connector ("+this.id+") returned with the following error: '"+k+"'!");a.Util.removeElement(f,this.id)};if(d.connectors){if(d.connectors.indexOf(this.id)!==-1){a.log("info","VIE2.core#analyze()","Starting analysis with connector: '"+this.id+"'!");this.analyze(g.element,{success:i,error:j})}else{a.log("info","VIE2.core#analyze()","Will not use connector "+this.id+" as it is filtered!")}}else{a.log("info","VIE2.core#analyze()","Starting analysis with connector: '"+this.id+"'!");this.analyze(g.element,{success:i,error:j})}})},uris:function(){return this.options.entities},copy:function(d){var f=this;if(!d){a.log("warn","VIE2.core#copy()","Invoked 'copy()' without target element!");return}a.log("info","VIE2.core#copy()","Start.");a.log("info","VIE2.core#copy()","Found "+this.options.entities.length+" entities for source.");jQuery(d).vie2().vie2("option","entities",this.options.entities);a.log("info","VIE2.core#copy()","Finished.");a.log("info","VIE2.core#copy()","Target element has now "+jQuery(d).vie2("option","entities")+" entities.");return this},clear:function(){this.options.entities={};return this}})}(jQuery));if(typeof a=="undefined"||!a){a={}}a.namespaces={};a.globalCache=jQuery.rdf({namespaces:a.namespaces});a.clearCache=function(){a.globalCache=jQuery.rdf({namespaces:a.namespaces})};a.getFromCache=function(d,f,g){var c=a.ObjectCollection.extend({uri:f,property:g,parent:d});var b=new c();a.globalCache.where(jQuery.rdf.pattern(f,g,"?object",{namespaces:a.namespaces})).each(function(){if(this.object.type){if(this.object.type==="literal"){var h=a.createLiteral(this.object.value,{lang:this.object.lang,datatype:this.object.datatype,backend:true,silent:true});b.add(h,{backend:true,silent:true})}else{if(this.object.type==="uri"||this.object.type==="bnode"){if(VIE.EntityManager.getBySubject(this.object.toString())!==undefined){b.add(VIE.EntityManager.getBySubject(this.object.toString()),{backend:true,silent:true})}else{var h=a.createResource(this.object.value.toString(),{backend:true,silent:true});b.add(h,{backend:true,silent:true})}}}}});return b};a.removeFromCache=function(b,f,d){var c=jQuery.rdf.pattern(b,(f)?f:"?x",(d)?d:"?y",{namespaces:a.namespaces});a.log("info","VIE2.removeFromCache()","Removing triples that match: '"+c.toString()+"'!");a.log("info","VIE2.removeFromCache()","Global Cache now holds "+a.globalCache.databank.triples().length+" triples!");a.globalCache.where(c).remove(c);a.log("info","VIE2.removeFromCache()","Global Cache now holds "+a.globalCache.databank.triples().length+" triples!")};a.lookup=function(g,f,h){a.log("info","VIE2.lookup()","Start ('"+g+"', '"+f+"')!");if(g===undefined||typeof g!=="string"||f===undefined){a.log("warn","VIE2.lookup()","Invoked 'lookup()' with wrong/undefined argument(s)!");if(h){h.call(g,b)}return}if(!jQuery.isArray(f)){a.lookup(g,[f],h);return}var b={};for(var c=0;c<f.length;c++){b[f[c]]=[]}var d=[];jQuery.each(a.connectors,function(){d.push(this.id)});jQuery.each(a.connectors,function(){a.log("info","VIE2.lookup()","Start with connector '"+this.id+"' for uri '"+g+"'!");var i=function(k,j,l){return function(m){a.log("info","VIE2.lookup()","Received query information from connector '"+this.id+"' for uri '"+k+"'!");jQuery.each(m,function(o,n){for(var p=0;p<n.length;p++){var q=jQuery.rdf.triple(k,o,n[p],{namespaces:a.namespaces});a.globalCache.add(q)}});a.Util.removeElement(d,this.id);if(d.length===0){jQuery.each(j,function(n){a.globalCache.where(k+" "+n+" ?x").each(function(){var o=this.x.toString();if(j[n].indexOf(o)===-1){j[n].push(o)}})});a.log("info","VIE2.lookup()","Finished task: 'query()' for uri '"+k+"'!");a.log("info","VIE2.lookup()","Global Cache now holds "+a.globalCache.databank.triples().length+" triples!");if(l){l.call(k,j)}}}}(g,b,h);this.query(g,f,i)})};a.mappings={};a.registerMapping=function(b){if(!a.mappings[b.id]){var c=a.EntityCollection.extend({model:a.Entity});a.mappings[b.id]={a:(jQuery.isArray(b.types))?b.types:[b.types],collection:new c(),mapping:b};a.log("info","VIE2.registerMapping()","  Registered mapping '"+b.id+"'!")}else{a.log("warn","VIE2.registerMapping()","Did not register mapping, as there isalready a mapping with the same id registered.")}};a.unregisterMapping=function(b){a.mappings[b]=undefined};a.connectors={};a.registerConnector=function(b){if(!a.connectors[b.id]){a.connectors[b.id]=b;if(b.options("namespaces")){jQuery.each(b.options("namespaces"),function(d,c){a.namespaces[d]=c;a.globalCache.prefix(d,c)})}a.log("info","VIE2.registerConnector()","Registered connector '"+b.id+"'")}else{a.log("warn","VIE2.registerConnector()","Did not register connector, as there isalready a connector with the same id registered.")}};a.unregisterConnector=function(b){a.connectors[connector.id]=undefined};a.logLevels=["info","warn","error"];a.log=function(d,b,c){if(a.logLevels.indexOf(d)>-1){switch(d){case"info":console.info(b+" "+c);break;case"warn":console.warn(b+" "+c);break;case"error":console.error(b+" "+c);break}}};VIE.EntityManager.initializeCollection();a.EntityCollection=VIE.RDFEntityCollection.extend({_add:function(b,c){if(!c){c={}}VIE.RDFEntityCollection.prototype._add.call(this,b,c);if(!c.backend){var d=jQuery.rdf.triple(b.get("id"),"a","owl:Thing",{namespaces:a.namespaces});a.globalCache.add(d)}a.lookup(b.get("id"),["a"],function(f){return function(){f.trigger("change:a")}}(b))},_remove:function(b,c){if(!c){c={}}if(b){if(a.entities===this){a.removeFromCache(b.get("id"),"?x","?y");jQuery.each(a.mappings,function(f,d){d.collection.remove(b)});VIE.EntityManager.entities.remove(b,c)}VIE.RDFEntityCollection.prototype._remove.call(this,b,c)}}});a.entities=new a.EntityCollection();a.ObjectCollection=Backbone.Collection.extend({_add:function(b,c){if(!c){c={}}b.collection=this;Backbone.Collection.prototype._add.call(this,b,c);if(!c.backend){var d=jQuery.rdf.triple(this.uri,this.property,b.tojQueryRdf(),{namespaces:a.namespaces});a.globalCache.add(d);if(this.parent){this.parent.change()}}},_remove:function(b,c){if(b){a.removeFromCache(this.uri,this.property,b.tojQueryRdf());Backbone.Collection.prototype._remove.call(this,b,c);this.parent.change()}},getByValue:function(d,b){if(!b){b={}}var c;$.each(this.models,function(g,f){if(f.get("value")===d){if(b.lang){if(b.lang===f.get("lang")){c=f;return false}}else{if(b.datatype){if(b.datatype===f.get("datatype")){c=f;return false}}else{c=f;return false}}}});return c}});a.Entity=VIE.RDFEntity.extend({initialize:function(c,f){this.bind("change:a",this.searchCollections);if(!f){f={}}if(!f.backend){for(var b in c){var h=c[b];if(b!=="id"){if(jQuery.isArray(h)){for(var d=0;d<h.length;d++){var g=jQuery.rdf.triple(this.id,b,h[d],{namespaces:a.namespaces});a.globalCache.add(g)}}else{var g=jQuery.rdf.triple(this.id,b,h,{namespaces:a.namespaces});a.globalCache.add(g)}}}}},searchCollections:function(){var b=this;var c=a.getFromCache(this,this.get("id"),"a");jQuery.each(a.mappings,function(g,f){var j=false;for(var d=0;d<c.length;d++){var h=c.at(d).get("value");if(!a.Util.isCurie(h)){h=jQuery.createCurie(h.replace(/^</,"").replace(/>$/,""),{namespaces:a.namespaces,charcase:"lower"}).toString()}if(f.a.indexOf(h)!==-1){j=true;break}}if(j){if(!f.collection.get(b.id)){f.collection.add(b,{backend:true});a.log("info","VIE2.Entity.searchCollections()","Added entity '"+b.get("id")+"' to collection of type '"+g+"'!");a.log("info","VIE2.Entity.searchCollections()","Querying for default properties for entity '"+b.get("id")+"': ["+f.mapping.defaults.join(", ")+"]!");a.lookup(b.get("id"),f.mapping.defaults,function(k,i){return function(){a.log("info","VIE2.Entity.searchCollections()","Finished querying for default properties for entity '"+i.get("id")+"': ["+k.join(", ")+"]!");for(var l=0;l<k.length;l++){i.trigger("change:"+k[l])}i.change()}}(f.mapping.defaults,b))}}})},get:function(b){if(b==="id"){return VIE.RDFEntity.prototype.get.call(this,b)}return a.getFromCache(this,this.get("id"),b)}});a.createEntity=function(c,d){if(!("id" in c)){c.id=$.rdf.blank("[]").toString()}var b=new a.Entity(c,d);a.entities.add(b,d);return b};a.Object=Backbone.Model.extend({initialize:function(b,c){if(!c){c={}}this.isLiteral=c.isLiteral},set:function(c,d){if(!d){d={}}if(!c){return this}var b=this.attributes.value;var g=c.value;if(b!==undefined&&b!==g){if(this.collection){var f=a.createLiteral(g,{lang:this.attributes.lang,datatype:this.attributes.datatype});this.collection.add(f);this.collection.parent.change();this.collection.remove(this)}}return Backbone.Model.prototype.set.call(this,c,d)},tojQueryRdf:function(){if(this.isLiteral){return this._tojQueryRdfLit()}else{return this._tojQueryRdfRes()}},_tojQueryRdfLit:function(){var c=(this.get("lang"))?this.get("lang"):undefined;var b=(this.get("datatype"))?this.get("datatype"):undefined;if(c!==undefined&&b!==undefined){b=undefined}return jQuery.rdf.literal(this.get("value"),{namespaces:a.namespaces,datatype:b,lang:c})},_tojQueryRdfRes:function(){return jQuery.rdf.resource(this.get("value"),{namespaces:a.namespaces})}});a.createLiteral=function(c,b){if(!b){b={}}return new a.Object({value:c,isResource:false,lang:b.lang,datatype:b.datatype,},jQuery.extend(b,{isLiteral:true}))};a.createResource=function(c,b){if(!b){b={}}return new a.Object({value:c,isLiteral:false,isResource:true},jQuery.extend(b,{isLiteral:false}))};a.Connector=function(c,b){if(c===undefined||typeof c!=="string"){throw"The connector constructor needs an 'id' of type 'string'!"}this.id=c;this._options=(b)?b:{};a.registerConnector(this)};a.Connector.prototype.options=function(b){if(typeof b==="string"){return this._options[b]}else{if(typeof b==="object"){jQuery.extend(true,this._options,b)}else{return this._options}}};a.Connector.prototype.analyze=function(c,b){a.log("info","VIE2.Connector("+this.id+")#analyze()","Not overwritten!");if(b&&b.success){b.success.call(this,jQuery.rdf())}};a.Connector.prototype.query=function(c,b,d){a.log("info","VIE2.Connector("+this.id+")#query()","Not overwritten!");d.call(this,{})};a.Mapping=function(k,f,h,b){if(k===undefined){throw"The mapping constructor needs an 'id'!"}if(typeof k!=="string"){throw"The mapping constructor needs an 'id' of type 'string'!"}if(f===undefined){throw"The mapping constructor needs 'types'!"}this.id=k;this.options=(b)?b:{};if(this.options.namespaces){jQuery.each(this.options.namespaces,function(i,d){a.namespaces[i]=d;a.globalCache.prefix(i,d)})}this.types=[];for(var c=0;c<f.length;c++){var g=f[c];if(!a.Util.isCurie(g)){g=jQuery.createCurie(g.replace(/^</,"").replace(/>$/,""),{namespaces:a.namespaces,charcase:"lower"}).toString()}this.types.push(g)}this.defaults=[];for(var c=0;c<h.length;c++){var j=h[c];if(!a.Util.isCurie(j)){j=jQuery.createCurie(j.replace(/^</,"").replace(/>$/,""),{namespaces:a.namespaces,charcase:"lower"}).toString()}this.defaults.push(j)}a.registerMapping(this)};a.Util={};a.Util.removeElement=function(b,c){if(jQuery.isArray(b)){jQuery.each(b,function(d){if(b[d]===c){b.splice(d,1);return false}})}};a.Util.isCurie=function(b){return !b.substring(0,1).match(/^<$/)&&!(b.substring(0,7).match(/^http:\/\/$/))};a.Util.isLiteral=function(h){try{jQuery.rdf.resource(h,{namespaces:a.namespaces});return false}catch(d){try{jQuery.rdf.blank(h,{namespaces:a.namespaces});return false}catch(c){try{jQuery.rdf.literal(h,{namespaces:a.namespaces});return true}catch(b){return false}}}};a.Util.isBlank=function(d){try{jQuery.rdf.resource(d,{namespaces:a.namespaces});return false}catch(c){try{jQuery.rdf.blank(d,{namespaces:a.namespaces});return true}catch(b){return false}}};jQuery(document).vie2()}).call(this);